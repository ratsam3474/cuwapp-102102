<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CuWhapp - Choose Payment Method</title>
    
    <!-- Existing styles -->
    <link rel="stylesheet" href="/static/css/style.css">
    
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }
        
        .checkout-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 100%;
            margin: 20px;
            padding: 40px;
        }
        
        .checkout-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .checkout-header h1 {
            font-size: 28px;
            color: #333;
            margin-bottom: 10px;
        }
        
        .plan-details {
            background: #f7f8fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .plan-name {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }
        
        .plan-price {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
        }
        
        .plan-price span {
            font-size: 16px;
            color: #999;
            font-weight: normal;
        }
        
        .payment-methods {
            margin: 30px 0;
        }
        
        .payment-method {
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .payment-method:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }
        
        .payment-method.selected {
            border-color: #667eea;
            background: #f8f9ff;
            box-shadow: 0 0 0 1px #667eea;
        }
        
        .payment-method-left {
            display: flex;
            align-items: center;
        }
        
        .payment-method-icon {
            width: 48px;
            height: 48px;
            margin-right: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        .payment-method-info h3 {
            margin: 0 0 5px 0;
            font-size: 18px;
            color: #333;
        }
        
        .payment-method-info p {
            margin: 0;
            font-size: 14px;
            color: #666;
        }
        
        .payment-method-radio {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid #d0d0d0;
            position: relative;
        }
        
        .payment-method.selected .payment-method-radio {
            border-color: #667eea;
        }
        
        .payment-method.selected .payment-method-radio::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #667eea;
        }
        
        .payment-badges {
            display: flex;
            gap: 10px;
            margin-top: 8px;
        }
        
        .badge {
            padding: 2px 8px;
            background: #f0f0f0;
            border-radius: 4px;
            font-size: 11px;
            color: #666;
        }
        
        .continue-button {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 20px;
        }
        
        .continue-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }
        
        .continue-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .security-note {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 20px;
            font-size: 13px;
            color: #666;
        }
        
        .security-note svg {
            width: 16px;
            height: 16px;
            margin-right: 5px;
        }
        
        .back-link {
            display: inline-block;
            margin-top: 20px;
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
        }
        
        .back-link:hover {
            text-decoration: underline;
        }
        
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }
        
        .loading-overlay.active {
            display: flex;
        }
        
        .loading-modal {
            background: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="checkout-container">
        <div class="checkout-header">
            <h1>üöÄ Choose Payment Method</h1>
            <p style="color: #666;">Select how you'd like to pay</p>
        </div>
        
        <div class="plan-details">
            <div class="plan-name" id="plan-name">Loading...</div>
            <div class="plan-price" id="plan-price">
                $<span id="price-amount">0</span><span>/month</span>
            </div>
        </div>
        
        <div class="payment-methods">
            <!-- Stripe Payment Method -->
            <div class="payment-method" data-method="stripe" onclick="selectPaymentMethod('stripe')">
                <div class="payment-method-left">
                    <div class="payment-method-icon">üí≥</div>
                    <div class="payment-method-info">
                        <h3>Credit/Debit Card</h3>
                        <p>Pay securely with Stripe</p>
                        <div class="payment-badges">
                            <span class="badge">Visa</span>
                            <span class="badge">Mastercard</span>
                            <span class="badge">Amex</span>
                        </div>
                    </div>
                </div>
                <div class="payment-method-radio"></div>
            </div>
            
            <!-- Crypto Payment Method -->
            <div class="payment-method" data-method="crypto" onclick="selectPaymentMethod('crypto')">
                <div class="payment-method-left">
                    <div class="payment-method-icon">‚Çø</div>
                    <div class="payment-method-info">
                        <h3>Cryptocurrency</h3>
                        <p>Pay with Bitcoin, Ethereum, USDT & more</p>
                        <div class="payment-badges">
                            <span class="badge">BTC</span>
                            <span class="badge">ETH</span>
                            <span class="badge">USDT</span>
                            <span class="badge">USDC</span>
                        </div>
                    </div>
                </div>
                <div class="payment-method-radio"></div>
            </div>
        </div>
        
        <button id="continue-button" class="continue-button" disabled onclick="proceedToPayment()">
            Select a Payment Method
        </button>
        
        <div class="security-note">
            <svg fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"></path>
            </svg>
            Secure payment processing
        </div>
        
        <center>
            <a href="/" class="back-link">‚Üê Back to Dashboard</a>
        </center>
    </div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-modal">
            <div class="spinner"></div>
            <p>Redirecting to secure checkout...</p>
        </div>
    </div>
    
    <!-- Include user cache system -->
    <script src="/static/js/user-cache.js"></script>
    
    <script>
        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const planId = urlParams.get('plan') || 'starter';
        const userId = urlParams.get('user_id');
        const email = urlParams.get('email') || 'test@example.com';
        
        // Plan details mapping
        const plans = {
            starter: { name: 'Starter Plan', price: 7 },
            hobby: { name: 'Hobby Plan', price: 20 },
            pro: { name: 'Pro Plan', price: 45 },
            premium: { name: 'Premium Plan', price: 99 }
        };
        
        // Selected payment method
        let selectedMethod = null;
        
        // Update UI with plan details
        if (planId && plans[planId]) {
            document.getElementById('plan-name').textContent = plans[planId].name;
            document.getElementById('price-amount').textContent = plans[planId].price;
        }
        
        // Get user from cache or URL
        function getUser() {
            let user = UserCache.getUser();
            
            if (!user && userId) {
                user = {
                    id: userId,
                    email: decodeURIComponent(email),
                    username: decodeURIComponent(email).split('@')[0]
                };
                UserCache.setUser(user);
            }
            
            return user;
        }
        
        // Select payment method
        function selectPaymentMethod(method) {
            // Remove selected class from all methods
            document.querySelectorAll('.payment-method').forEach(el => {
                el.classList.remove('selected');
            });
            
            // Add selected class to chosen method
            document.querySelector(`[data-method="${method}"]`).classList.add('selected');
            
            // Update selected method
            selectedMethod = method;
            
            // Update button
            const button = document.getElementById('continue-button');
            button.disabled = false;
            button.textContent = method === 'stripe' ? 
                'Continue with Card Payment' : 
                'Continue with Crypto Payment';
        }
        
        // Proceed to payment
        async function proceedToPayment() {
            if (!selectedMethod) {
                alert('Please select a payment method');
                return;
            }
            
            const user = getUser();
            if (!user) {
                alert('Please sign in to continue');
                window.location.href = 'https://auth.cuwapp.com/sign-in';
                return;
            }
            
            // Show loading overlay
            document.getElementById('loading-overlay').classList.add('active');
            
            try {
                // Call the direct payment API
                const response = await fetch('/api/direct-payments/create-checkout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        plan_id: planId,
                        user_id: user.id,
                        email: user.email,
                        payment_method: selectedMethod
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.checkout_url) {
                    // Store session info for later verification
                    sessionStorage.setItem('payment_session', JSON.stringify({
                        method: selectedMethod,
                        session_id: data.session_id,
                        plan_id: planId,
                        timestamp: new Date().toISOString()
                    }));
                    
                    // Redirect to payment provider
                    window.location.href = data.checkout_url;
                } else {
                    throw new Error(data.error || 'Failed to create checkout session');
                }
            } catch (error) {
                console.error('Payment initialization error:', error);
                alert('Failed to initialize payment: ' + error.message);
                document.getElementById('loading-overlay').classList.remove('active');
            }
        }
        
        // Check if user is authenticated on page load
        document.addEventListener('DOMContentLoaded', function() {
            const user = getUser();
            if (!user) {
                console.warn('No user found, redirecting to sign in...');
                // Optionally redirect to sign in
                // window.location.href = 'https://auth.cuwapp.com/sign-in';
            }
        });
    </script>
</body>
</html>