<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout Debug - CuWhapp</title>
    
    <!-- Hyperswitch SDK -->
    <script src="https://beta.hyperswitch.io/v1/HyperLoader.js"></script>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .debug-log {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        button {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #5569d4;
        }
        #unified-checkout {
            margin: 20px 0;
            min-height: 300px;
            border: 2px dashed #ccc;
            padding: 20px;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <h1>Hyperswitch Checkout Debug</h1>
    
    <div id="debug-output"></div>
    
    <div>
        <button onclick="testPaymentIntent()">1. Test Payment Intent Creation</button>
        <button onclick="initializeHyperswitch()">2. Initialize Hyperswitch SDK</button>
        <button onclick="createPaymentWidget()">3. Create Payment Widget</button>
    </div>
    
    <div id="unified-checkout">
        <p>Payment form will appear here...</p>
    </div>
    
    <script>
        const debugLog = (message, type = 'info') => {
            const output = document.getElementById('debug-output');
            const entry = document.createElement('div');
            entry.className = `debug-log ${type}`;
            entry.textContent = `[${new Date().toISOString()}] ${message}`;
            output.appendChild(entry);
            console.log(message);
        };
        
        let clientSecret = null;
        let hyper = null;
        let widgets = null;
        
        // Step 1: Test Payment Intent Creation
        async function testPaymentIntent() {
            debugLog('Testing payment intent creation...', 'info');
            
            try {
                const response = await fetch('/api/payments/create-payment-intent', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        plan_id: 'starter',
                        amount: 700,
                        user_id: 'test_user_' + Date.now(),
                        email: 'test@example.com',
                        return_url: 'https://app.cuwapp.com/payment-success',
                        cancel_url: 'https://app.cuwapp.com/payment-cancelled'
                    })
                });
                
                debugLog(`Response status: ${response.status}`, response.ok ? 'success' : 'error');
                
                const data = await response.json();
                debugLog(`Response data: ${JSON.stringify(data, null, 2)}`, 'info');
                
                if (data.success && data.clientSecret) {
                    clientSecret = data.clientSecret;
                    debugLog(`✅ Client secret received: ${clientSecret}`, 'success');
                    debugLog('Now click "2. Initialize Hyperswitch SDK"', 'info');
                } else {
                    debugLog(`❌ Failed to get client secret`, 'error');
                }
                
            } catch (error) {
                debugLog(`❌ Error: ${error.message}`, 'error');
                debugLog(`Stack: ${error.stack}`, 'error');
            }
        }
        
        // Step 2: Initialize Hyperswitch
        function initializeHyperswitch() {
            debugLog('Initializing Hyperswitch SDK...', 'info');
            
            try {
                // Check if Hyper is loaded
                if (typeof Hyper === 'undefined') {
                    debugLog('❌ Hyper is not defined. SDK may not be loaded.', 'error');
                    debugLog('Trying to reload SDK...', 'info');
                    
                    const script = document.createElement('script');
                    script.src = 'https://beta.hyperswitch.io/v1/HyperLoader.js';
                    script.onload = () => {
                        debugLog('SDK script loaded, retrying initialization...', 'info');
                        initializeHyperswitch();
                    };
                    script.onerror = () => {
                        debugLog('❌ Failed to load SDK script', 'error');
                    };
                    document.head.appendChild(script);
                    return;
                }
                
                debugLog('✅ Hyper is available', 'success');
                
                // Your cloud sandbox publishable key
                const publishableKey = 'pk_snd_68a3be601ff24b82a4b163a8b3d046b2';
                debugLog(`Using publishable key: ${publishableKey}`, 'info');
                
                // Initialize without custom backend URL - let it use default
                // The SDK will communicate with Hyperswitch cloud which will validate with your account
                hyper = Hyper(publishableKey);
                
                debugLog('✅ Hyper initialized', 'success');
                debugLog('Hyper object properties: ' + Object.keys(hyper).join(', '), 'info');
                
                if (!clientSecret) {
                    debugLog('⚠️ No client secret yet. Run "1. Test Payment Intent Creation" first', 'error');
                } else {
                    debugLog('Now click "3. Create Payment Widget"', 'info');
                }
                
            } catch (error) {
                debugLog(`❌ Error initializing Hyper: ${error.message}`, 'error');
                debugLog(`Stack: ${error.stack}`, 'error');
            }
        }
        
        // Step 3: Create Payment Widget
        function createPaymentWidget() {
            debugLog('Creating payment widget...', 'info');
            
            if (!hyper) {
                debugLog('❌ Hyper not initialized. Run step 2 first.', 'error');
                return;
            }
            
            if (!clientSecret) {
                debugLog('❌ No client secret. Run step 1 first.', 'error');
                return;
            }
            
            try {
                debugLog(`Using client secret: ${clientSecret}`, 'info');
                
                // Create widgets
                widgets = hyper.widgets({
                    clientSecret: clientSecret,
                    appearance: {
                        theme: 'default'
                    }
                });
                
                debugLog('✅ Widgets created', 'success');
                debugLog('Widget methods: ' + Object.keys(widgets).join(', '), 'info');
                
                // Create unified checkout
                const unifiedCheckout = widgets.create('payment', {
                    layout: 'tabs',
                    wallets: {
                        walletReturnUrl: 'https://app.cuwapp.com/payment-success'
                    }
                });
                
                debugLog('✅ Unified checkout created', 'success');
                
                // Mount the widget
                const container = document.getElementById('unified-checkout');
                container.innerHTML = ''; // Clear existing content
                unifiedCheckout.mount('#unified-checkout');
                
                debugLog('✅ Payment widget mounted!', 'success');
                debugLog('You should now see the payment form', 'info');
                
            } catch (error) {
                debugLog(`❌ Error creating widget: ${error.message}`, 'error');
                debugLog(`Stack: ${error.stack}`, 'error');
            }
        }
        
        // Auto-check on load
        window.addEventListener('DOMContentLoaded', () => {
            debugLog('Page loaded', 'info');
            debugLog('Checking if Hyper SDK is available...', 'info');
            
            setTimeout(() => {
                if (typeof Hyper !== 'undefined') {
                    debugLog('✅ Hyper SDK is loaded', 'success');
                    debugLog('Click the buttons in order to test', 'info');
                } else {
                    debugLog('⚠️ Hyper SDK not loaded yet', 'error');
                }
            }, 1000);
        });
    </script>
</body>
</html>