<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Email Templates | CuWhapp Admin</title>

  <!-- Google Font: Source Sans Pro -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Theme style -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css">
  <!-- CodeMirror for HTML editing -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">
  
  <style>
    .template-card {
      cursor: pointer;
      transition: all 0.3s;
      height: 100%;
    }
    .template-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    .template-card.active {
      border: 2px solid #28a745;
    }
    .email-preview {
      border: 1px solid #dee2e6;
      border-radius: 8px;
      height: 600px;
      overflow: auto;
    }
    .template-thumbnail {
      height: 200px;
      overflow: hidden;
      border-radius: 8px;
      background: #f8f9fa;
    }
    .template-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1;
    }
    .CodeMirror {
      height: 400px;
      border: 1px solid #dee2e6;
      border-radius: 4px;
    }
  </style>
</head>
<body class="hold-transition sidebar-mini layout-fixed">
<div class="wrapper">

  <!-- Navbar -->
  <nav class="main-header navbar navbar-expand navbar-white navbar-light">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a>
      </li>
      <li class="nav-item d-none d-sm-inline-block">
        <a href="/" class="nav-link">Dashboard</a>
      </li>
      <li class="nav-item d-none d-sm-inline-block">
        <a href="/email-templates" class="nav-link active">Email Templates</a>
      </li>
    </ul>
  </nav>

  <!-- Main Sidebar Container -->
  <aside class="main-sidebar sidebar-dark-primary elevation-4">
    <a href="/" class="brand-link">
      <span class="brand-text font-weight-light">CuWhapp Admin</span>
    </a>
    <div class="sidebar">
      <nav class="mt-2">
        <ul class="nav nav-pills nav-sidebar flex-column" role="menu">
          <li class="nav-item">
            <a href="/" class="nav-link">
              <i class="nav-icon fas fa-tachometer-alt"></i>
              <p>Dashboard</p>
            </a>
          </li>
          <li class="nav-item">
            <a href="/email-templates" class="nav-link active">
              <i class="nav-icon fas fa-envelope"></i>
              <p>Email Templates</p>
            </a>
          </li>
        </ul>
      </nav>
    </div>
  </aside>

  <!-- Content Wrapper -->
  <div class="content-wrapper">
    <!-- Content Header -->
    <div class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">
            <h1 class="m-0">Email Templates</h1>
          </div>
          <div class="col-sm-6">
            <ol class="breadcrumb float-sm-right">
              <li class="breadcrumb-item"><a href="/">Home</a></li>
              <li class="breadcrumb-item active">Email Templates</li>
            </ol>
          </div>
        </div>
      </div>
    </div>

    <!-- Main content -->
    <section class="content">
      <div class="container-fluid">
        
        <!-- Template Selection -->
        <div class="row mb-4">
          <div class="col-12">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">Choose a Template</h3>
                <div class="card-tools">
                  <button class="btn btn-success btn-sm" onclick="createCustomTemplate()">
                    <i class="fas fa-plus"></i> Create Custom Template
                  </button>
                </div>
              </div>
              <div class="card-body">
                <div class="row" id="template-grid">
                  <!-- Default Template -->
                  <div class="col-md-4 mb-3">
                    <div class="card template-card" onclick="selectTemplate('welcome_default')">
                      <div class="position-relative">
                        <span class="badge badge-primary template-badge">Default</span>
                        <div class="template-thumbnail">
                          <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 300'%3E%3Crect fill='%231a4d2e' width='400' height='80'/%3E%3Ctext x='200' y='50' text-anchor='middle' fill='white' font-size='24' font-family='Arial'%3EWelcome!%3C/text%3E%3Crect fill='%23f8f9fa' y='80' width='400' height='220'/%3E%3Ctext x='200' y='150' text-anchor='middle' fill='%23333' font-size='16' font-family='Arial'%3EProfessional Template%3C/text%3E%3C/svg%3E" alt="Default Template" class="img-fluid">
                        </div>
                      </div>
                      <div class="card-body">
                        <h5 class="card-title">Professional Welcome</h5>
                        <p class="card-text text-muted">Clean, professional design with all features highlighted</p>
                      </div>
                    </div>
                  </div>

                  <!-- Premium Template -->
                  <div class="col-md-4 mb-3">
                    <div class="card template-card" onclick="selectTemplate('welcome_premium')">
                      <div class="position-relative">
                        <span class="badge badge-warning template-badge">Premium</span>
                        <div class="template-thumbnail">
                          <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 300'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23667eea'/%3E%3Cstop offset='100%25' style='stop-color:%23764ba2'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect fill='url(%23grad)' width='400' height='100'/%3E%3Ctext x='200' y='60' text-anchor='middle' fill='white' font-size='28' font-family='Arial'%3EPREMIUM%3C/text%3E%3Crect fill='white' y='100' width='400' height='200'/%3E%3Ctext x='200' y='180' text-anchor='middle' fill='%23667eea' font-size='18' font-family='Arial'%3EAnimated Design%3C/text%3E%3C/svg%3E" alt="Premium Template" class="img-fluid">
                        </div>
                      </div>
                      <div class="card-body">
                        <h5 class="card-title">Premium Animated</h5>
                        <p class="card-text text-muted">Eye-catching gradient design with animations</p>
                      </div>
                    </div>
                  </div>

                  <!-- Minimal Template -->
                  <div class="col-md-4 mb-3">
                    <div class="card template-card" onclick="selectTemplate('welcome_minimal')">
                      <div class="position-relative">
                        <span class="badge badge-info template-badge">Minimal</span>
                        <div class="template-thumbnail">
                          <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 300'%3E%3Crect fill='white' width='400' height='300'/%3E%3Ctext x='200' y='80' text-anchor='middle' fill='%231a4d2e' font-size='32' font-family='Arial' font-weight='bold'%3ECuWhapp%3C/text%3E%3Cline x1='150' y1='110' x2='250' y2='110' stroke='%23e0e0e0' stroke-width='1'/%3E%3Ctext x='200' y='160' text-anchor='middle' fill='%23666' font-size='14' font-family='Arial'%3ESimple. Clean. Effective.%3C/text%3E%3C/svg%3E" alt="Minimal Template" class="img-fluid">
                        </div>
                      </div>
                      <div class="card-body">
                        <h5 class="card-title">Minimal Clean</h5>
                        <p class="card-text text-muted">Simple, distraction-free design</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Template Editor and Preview -->
        <div class="row">
          <!-- Preview Panel -->
          <div class="col-lg-6">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">Email Preview</h3>
                <div class="card-tools">
                  <button class="btn btn-sm btn-primary" onclick="sendTestEmail()">
                    <i class="fas fa-paper-plane"></i> Send Test Email
                  </button>
                </div>
              </div>
              <div class="card-body p-0">
                <iframe id="email-preview" class="email-preview w-100" src=""></iframe>
              </div>
            </div>
          </div>

          <!-- Controls Panel -->
          <div class="col-lg-6">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">Template Settings</h3>
              </div>
              <div class="card-body">
                <!-- Test Form -->
                <form id="test-email-form">
                  <div class="form-group">
                    <label>Selected Template</label>
                    <input type="text" class="form-control" id="selected-template" value="welcome_default" readonly>
                  </div>
                  
                  <div class="form-group">
                    <label>Test Recipient Name</label>
                    <input type="text" class="form-control" id="test-name" placeholder="John Doe" value="John Doe">
                  </div>
                  
                  <div class="form-group">
                    <label>Test Recipient Email</label>
                    <input type="email" class="form-control" id="test-email" placeholder="test@example.com">
                  </div>
                  
                  <div class="form-group">
                    <label>Email Subject</label>
                    <input type="text" class="form-control" id="email-subject" value="Welcome to CuWhapp!" placeholder="Welcome to CuWhapp!">
                  </div>
                  
                  <div class="form-check mb-3">
                    <input type="checkbox" class="form-check-input" id="test-mode" checked>
                    <label class="form-check-label" for="test-mode">
                      Test Mode (adds [TEST] to subject)
                    </label>
                  </div>
                  
                  <button type="button" class="btn btn-success btn-block" onclick="sendTestEmail()">
                    <i class="fas fa-envelope"></i> Send Test Welcome Email
                  </button>
                </form>
                
                <hr>
                
                <!-- Template Variables -->
                <div class="mt-4">
                  <h5>Available Variables</h5>
                  <p class="text-muted">Use these variables in your templates:</p>
                  <ul class="list-unstyled">
                    <li><code>{{name}}</code> - Recipient's name</li>
                    <li><code>{{email}}</code> - Recipient's email</li>
                    <li><code>{{current_year}}</code> - Current year</li>
                    <li><code>{{dashboard_url}}</code> - Dashboard URL</li>
                    <li><code>{{blog_url}}</code> - Blog URL</li>
                  </ul>
                </div>
                
                <!-- Statistics -->
                <div class="mt-4">
                  <h5>Email Statistics</h5>
                  <div class="row">
                    <div class="col-6">
                      <div class="info-box">
                        <span class="info-box-icon bg-success"><i class="fas fa-check"></i></span>
                        <div class="info-box-content">
                          <span class="info-box-text">Sent Today</span>
                          <span class="info-box-number" id="emails-sent-today">0</span>
                        </div>
                      </div>
                    </div>
                    <div class="col-6">
                      <div class="info-box">
                        <span class="info-box-icon bg-info"><i class="fas fa-clock"></i></span>
                        <div class="info-box-content">
                          <span class="info-box-text">Queued</span>
                          <span class="info-box-number" id="emails-queued">0</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </section>
  </div>

  <!-- Footer -->
  <footer class="main-footer">
    <div class="float-right d-none d-sm-block">
      <b>Version</b> 1.0.0
    </div>
    <strong>CuWhapp Admin Dashboard</strong>
  </footer>
</div>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Bootstrap 4 -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- AdminLTE App -->
<script src="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/js/adminlte.min.js"></script>
<!-- CodeMirror -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/xml/xml.min.js"></script>

<script>
// Global variables
let selectedTemplate = 'welcome_default';
let codeEditor = null;

// Load templates on page load
$(document).ready(function() {
    loadTemplates();
    selectTemplate('welcome_default');
    loadEmailStats();
});

// Load available templates
async function loadTemplates() {
    try {
        const response = await fetch('/api/email/templates');
        const templates = await response.json();
        // Templates are already displayed in HTML, this is for future dynamic loading
    } catch (error) {
        console.error('Error loading templates:', error);
    }
}

// Select a template
function selectTemplate(templateName) {
    selectedTemplate = templateName;
    document.getElementById('selected-template').value = templateName;
    
    // Update active state
    document.querySelectorAll('.template-card').forEach(card => {
        card.classList.remove('active');
    });
    event?.currentTarget?.classList.add('active');
    
    // Load preview
    loadTemplatePreview(templateName);
}

// Load template preview
function loadTemplatePreview(templateName) {
    const previewFrame = document.getElementById('email-preview');
    previewFrame.src = `/api/email/templates/${templateName}/preview`;
}

// Send test email
async function sendTestEmail() {
    const name = document.getElementById('test-name').value || 'Test User';
    const email = document.getElementById('test-email').value;
    const testMode = document.getElementById('test-mode').checked;
    
    if (!email) {
        alert('Please enter a test email address');
        return;
    }
    
    try {
        const response = await fetch('/api/email/send-welcome', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer admin_secret_token_2024'
            },
            body: JSON.stringify({
                email: email,
                name: name,
                template_name: selectedTemplate,
                test_mode: testMode
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('Test email sent successfully! Check ' + email);
            loadEmailStats();
        } else {
            alert('Failed to send email: ' + result.message);
        }
    } catch (error) {
        console.error('Error sending test email:', error);
        alert('Error sending test email');
    }
}

// Load email statistics
async function loadEmailStats() {
    try {
        const response = await fetch('/api/email/stats');
        const stats = await response.json();
        
        document.getElementById('emails-sent-today').textContent = stats.newsletter_subscribers || 0;
        document.getElementById('emails-queued').textContent = stats.emails_queued || 0;
    } catch (error) {
        console.error('Error loading email stats:', error);
    }
}

// Create custom template (placeholder)
function createCustomTemplate() {
    alert('Custom template editor coming soon! For now, templates can be added via the API.');
}

// Auto-refresh stats every 30 seconds
setInterval(loadEmailStats, 30000);
</script>

</body>
</html>